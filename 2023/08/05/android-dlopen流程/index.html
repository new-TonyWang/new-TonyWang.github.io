<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5AUIVYTbHIAuz-eQtxSfZbWW5eg9_EVZMSQycIuXrG0">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.0","exturl":true,"sidebar":{"position":"left","display":"always","padding":10,"offset":5},"copycode":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/config.min.js"></script>

    <meta name="description" content="在android里面，所有的so文件在链接的时候最终都会调用到find_libraries()中。 链接时的名称空间：防止（Framework）和供应商（Vendor）的库中有相同符号，使用名称空间进行隔离。">
<meta property="og:type" content="article">
<meta property="og:title" content="android_dlopen流程">
<meta property="og:url" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Oh, Tony">
<meta property="og:description" content="在android里面，所有的so文件在链接的时候最终都会调用到find_libraries()中。 链接时的名称空间：防止（Framework）和供应商（Vendor）的库中有相同符号，使用名称空间进行隔离。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805220820178.png">
<meta property="og:image" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221048906.png">
<meta property="og:image" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221126743.png">
<meta property="og:image" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221336854.png">
<meta property="article:published_time" content="2023-08-04T16:51:58.000Z">
<meta property="article:modified_time" content="2023-08-04T17:04:15.320Z">
<meta property="article:author" content="Tony">
<meta property="article:tag" content="c++">
<meta property="article:tag" content="鹅">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805220820178.png">


<link rel="canonical" href="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/","path":"2023/08/05/android-dlopen流程/","title":"android_dlopen流程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>android_dlopen流程 | Oh, Tony</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43861RVV8R"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-43861RVV8R","only_pageview":false}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/analytics/google-analytics.min.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Oh, Tony</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-bell fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa fa-th fa-fw"></i>分类<span class="badge">10</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">33</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">39</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E5%99%A8%E8%87%AA%E4%B8%BE"><span class="nav-number">1.</span> <span class="nav-text">链接器自举</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8pc%E5%88%B0so%E6%96%87%E4%BB%B6pc%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="nav-number">2.</span> <span class="nav-text">寄存器PC到so文件PC的映射关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E8%BF%87%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">验证过程：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E7%AF%87%E7%BA%AA%E5%BF%B5%E9%80%9D%E5%8E%BB%E7%9A%84%E9%B9%85"><span class="nav-number">2.2.</span> <span class="nav-text">本篇纪念逝去的鹅</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tony"
      src="https://avatars.githubusercontent.com/u/46778179?v=4">
  <p class="site-author-name" itemprop="name">Tony</p>
  <div class="site-description" itemprop="description">GXG</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25ldy1Ub255V2FuZw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;new-TonyWang"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9uZXctdG9ueXdhbmcuZ2l0aHViLmlvL3dhbmd0b255eXUyMjJAZ21haWwuY29t" title="Email → https:&#x2F;&#x2F;new-tonywang.github.io&#x2F;wangtonyyu222@gmail.com"><i class="fa fa-envelope fa-fw"></i>Email</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9udWFhLXMzbGFiLmdpdGh1Yi5pby9kYWlseVBhcGVyLw==" title="S3Lab论文推荐 → https:&#x2F;&#x2F;nuaa-s3lab.github.io&#x2F;dailyPaper&#x2F;">S3Lab论文推荐</span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/46778179?v=4">
      <meta itemprop="name" content="Tony">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Oh, Tony">
      <meta itemprop="description" content="GXG">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="android_dlopen流程 | Oh, Tony">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          android_dlopen流程<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvdGhlbWUtbmV4dC1kb2NzL2VkaXQvbWFzdGVyL3NvdXJjZS9fcG9zdHMvYW5kcm9pZC1kbG9wZW7mtYHnqIsubWQ=" title="编辑"><i class="fa fa-pen-nib"></i></span>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-05 00:51:58" itemprop="dateCreated datePublished" datetime="2023-08-05T00:51:58+08:00">2023-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/08/05/android-dlopen流程/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>在android里面，所有的so文件在链接的时候最终都会调用到find_libraries()中。</p>
<p>链接时的名称空间：防止（Framework）和供应商（Vendor）的库中有相同符号，使用名称空间进行隔离。 <span id="more"></span> <pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
/bionic/linker/linker.cpp

*/</span>

<span class="token comment">// add_as_children - add first-level loaded libraries (i.e. library_names[], but</span>
<span class="token comment">// not their transitive dependencies) as children of the start_with library.</span>
<span class="token comment">// This is false when find_libraries is called for dlopen(), when newly loaded</span>
<span class="token comment">// libraries must form a disjoint tree.</span>
<span class="token comment">//该函数只能被两个地方调用，</span>
<span class="token comment">//1.dlopen()</span>
<span class="token comment">//2.linker_main中的连接器自举</span>
<span class="token comment">//总体流程如下：</span>
<span class="token comment">//1.以广度优先遍历的顺序存储动态库依赖树，通过dt_needed寻找该链接库需要的其他链接库，使用广度优先的策略进行遍历 </span>
<span class="token comment">//2. 将所有的链接库顺序打乱并装入内存</span>
<span class="token comment">//3.寻找所有链接库中的DYNAMIC相关的段，为链接做准备</span>
<span class="token comment">//4.将符号更新到got表中</span>
<span class="token keyword">bool</span> <span class="token function">find_libraries</span><span class="token punctuation">(</span>android_namespace_t<span class="token operator">*</span> ns<span class="token punctuation">,</span><span class="token comment">//这里是调用者的namespace</span>
                    soinfo<span class="token operator">*</span> start_with<span class="token punctuation">,</span><span class="token comment">//__builtin_return_address(0),是dlopen的返回地址</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> library_names<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//so文件名称</span>
                    size_t library_names_count<span class="token punctuation">,</span><span class="token comment">//1</span>
                    soinfo<span class="token operator">*</span> soinfos<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//需要返回的handle</span>
                    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> ld_preloads<span class="token punctuation">,</span><span class="token comment">//nullptr</span>
                    size_t ld_preloads_count<span class="token punctuation">,</span><span class="token comment">//0</span>
                    <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span><span class="token comment">//调用的参数</span>
                    <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span><span class="token comment">//(使用dlopen的时候为nullptr,使用android_dlopen_ext的时候传入值)</span>
                    <span class="token keyword">bool</span> add_as_children<span class="token punctuation">,</span><span class="token comment">//false</span>
                    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>android_namespace_t<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> namespaces<span class="token comment">//默认nullptr) &#123;</span>
  <span class="token comment">// Step 0: prepare.</span>
  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">const</span> soinfo<span class="token operator">*</span><span class="token punctuation">,</span> ElfReader<span class="token operator">></span> readers_map<span class="token punctuation">;</span>
  LoadTaskList load_tasks<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> library_names_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> library_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    load_tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token class-name">LoadTask</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> start_with<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readers_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// If soinfos array is null allocate one on stack.</span>
  <span class="token comment">// The array is needed in case of failure; for example</span>
  <span class="token comment">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span>
  <span class="token comment">// is loaded correctly but libtwo.so failed for some reason.</span>
  <span class="token comment">// In this case libone.so should be unloaded on return.</span>
  <span class="token comment">// See also implementation of failure_guard below.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>soinfos <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    size_t soinfos_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>library_names_count<span class="token punctuation">;</span>
    soinfos <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">alloca</span><span class="token punctuation">(</span>soinfos_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>soinfos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> soinfos_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// list of libraries to link - see step 2.</span>
  size_t soinfos_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> scope_guard <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span><span class="token function">make_scope_guard</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LoadTask<span class="token operator">*</span> t <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">LoadTask</span><span class="token double-colon punctuation">::</span><span class="token function">deleter</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ZipArchiveCache zip_archive_cache<span class="token punctuation">;</span>
  soinfo_list_t new_global_group_members<span class="token punctuation">;</span>

  <span class="token comment">// Step 1: expand the list of load_tasks to include</span>
  <span class="token comment">// all DT_NEEDED libraries (do not load them just yet)</span>
  <span class="token comment">// DT_NEEDED表示一个列表，列表里面以（NEEDED）为标志的项，就是当前库加载时要依赖的其它库。</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>load_tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    LoadTask<span class="token operator">*</span> task <span class="token operator">=</span> load_tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> is_dt_needed <span class="token operator">=</span> needed_by <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> start_with <span class="token operator">||</span> add_as_children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token operator">-></span><span class="token function">set_extinfo</span><span class="token punctuation">(</span>is_dt_needed <span class="token operator">?</span> <span class="token keyword">nullptr</span> <span class="token operator">:</span> extinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token operator">-></span><span class="token function">set_dt_needed</span><span class="token punctuation">(</span>is_dt_needed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"find_libraries(ns=%s): task=%s, is_dt_needed=%d"</span><span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_dt_needed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Note: start from the namespace that is stored in the LoadTask. This namespace</span>
    <span class="token comment">// is different from the current namespace when the LoadTask is for a transitive</span>
    <span class="token comment">// dependency and the lib that created the LoadTask is not found in the</span>
    <span class="token comment">// current namespace but in one of the linked namespace.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">find_library_internal</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>android_namespace_t<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">get_start_from</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               task<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>zip_archive_cache<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>load_tasks<span class="token punctuation">,</span>
                               rtld_flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_dt_needed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      needed_by<span class="token operator">-></span><span class="token function">add_child</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// When ld_preloads is not null, the first</span>
    <span class="token comment">// ld_preloads_count libs are in fact ld_preloads.</span>
    <span class="token keyword">bool</span> is_ld_preload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ld_preloads <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> soinfos_count <span class="token operator">&lt;</span> ld_preloads_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      ld_preloads<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
      is_ld_preload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>soinfos_count <span class="token operator">&lt;</span> library_names_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      soinfos<span class="token punctuation">[</span>soinfos_count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> si<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Add the new global group members to all initial namespaces. Do this secondary namespace setup</span>
    <span class="token comment">// at the same time that libraries are added to their primary namespace so that the order of</span>
    <span class="token comment">// global group members is the same in the every namespace. Only add a library to a namespace</span>
    <span class="token comment">// once, even if it appears multiple times in the dependency graph.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_ld_preload <span class="token operator">||</span> <span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_dt_flags_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> DF_1_GLOBAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> namespaces <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_global_group_members<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        new_global_group_members<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> linked_ns <span class="token operator">:</span> <span class="token operator">*</span>namespaces<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> linked_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            linked_ns<span class="token operator">-></span><span class="token function">add_soinfo</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
            si<span class="token operator">-></span><span class="token function">add_secondary_namespace</span><span class="token punctuation">(</span>linked_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 2: Load libraries in random order (see b/24047022)</span>
  <span class="token comment">// 打乱load的顺序</span>
  LoadTaskList load_list<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> pred <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> LoadTask<span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> t<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> si<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">find_if</span><span class="token punctuation">(</span>load_list<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> load_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pred<span class="token punctuation">)</span> <span class="token operator">==</span> load_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      load_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">bool</span> reserved_address_recursive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    reserved_address_recursive <span class="token operator">=</span> extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reserved_address_recursive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Shuffle the load order in the normal case, but not if we are loading all</span>
    <span class="token comment">// the libraries to a reserved address range.</span>
    <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>load_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Set up address space parameters.</span>
  address_space_params extinfo_params<span class="token punctuation">,</span> default_params<span class="token punctuation">;</span>
  size_t relro_fd_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      extinfo_params<span class="token punctuation">.</span>start_addr <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_addr<span class="token punctuation">;</span>
      extinfo_params<span class="token punctuation">.</span>reserved_size <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_size<span class="token punctuation">;</span>
      extinfo_params<span class="token punctuation">.</span>must_use_address <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_HINT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      extinfo_params<span class="token punctuation">.</span>start_addr <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_addr<span class="token punctuation">;</span>
      extinfo_params<span class="token punctuation">.</span>reserved_size <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_size<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token comment">//装入</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    address_space_params<span class="token operator">*</span> address_space <span class="token operator">=</span>
        <span class="token punctuation">(</span>reserved_address_recursive <span class="token operator">||</span> <span class="token operator">!</span>task<span class="token operator">-></span><span class="token function">is_dt_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>extinfo_params <span class="token operator">:</span> <span class="token operator">&amp;</span>default_params<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token operator">-></span><span class="token function">load</span><span class="token punctuation">(</span>address_space<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span>
 <span class="token comment">//以深度优先的方式找Dynamic段中需要链接的数据</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">prelink_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">register_soinfo_tls</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 4: Construct the global group. DF_1_GLOBAL bit is force set for LD_PRELOADed libs because</span>
  <span class="token comment">// they must be added to the global group. Note: The DF_1_GLOBAL bit for a library is normally set</span>
  <span class="token comment">// in step 3.</span>
  <span class="token comment">// </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ld_preloads <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> si <span class="token operator">:</span> <span class="token operator">*</span>ld_preloads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      si<span class="token operator">-></span><span class="token function">set_dt_flags_1</span><span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_dt_flags_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> DF_1_GLOBAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 5: Collect roots of local_groups.</span>
  <span class="token comment">// Whenever needed_by->si link crosses a namespace boundary it forms its own local_group.</span>
  <span class="token comment">// Here we collect new roots to link them separately later on. Note that we need to avoid</span>
  <span class="token comment">// collecting duplicates. Also the order is important. They need to be linked in the same</span>
  <span class="token comment">// BFS order we link individual libraries.</span>
  <span class="token comment">// 将so文件和ldpreload的so加入到</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">></span> local_group_roots<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>start_with <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> add_as_children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>start_with<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">CHECK</span><span class="token punctuation">(</span>soinfos_count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>soinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> is_dt_needed <span class="token operator">=</span> needed_by <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> start_with <span class="token operator">||</span> add_as_children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    android_namespace_t<span class="token operator">*</span> needed_by_ns <span class="token operator">=</span>
        is_dt_needed <span class="token operator">?</span> needed_by<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ns<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> needed_by_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">auto</span> it <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">find</span><span class="token punctuation">(</span>local_group_roots<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span>
             <span class="token string">"Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s"</span><span class="token punctuation">,</span>
             si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             si<span class="token punctuation">,</span>
             si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             needed_by <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">?</span> <span class="token string">"(nullptr)"</span> <span class="token operator">:</span> needed_by<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             needed_by<span class="token punctuation">,</span>
             ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             ns<span class="token punctuation">,</span>
             needed_by_ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             needed_by_ns<span class="token punctuation">,</span>
             it <span class="token operator">==</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"yes"</span> <span class="token operator">:</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 6: Link all local groups</span>
  <span class="token comment">//链接</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> root <span class="token operator">:</span> local_group_roots<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo_list_t local_group<span class="token punctuation">;</span>
    android_namespace_t<span class="token operator">*</span> local_group_ns <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">walk_dependencies_tree</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>local_group_ns<span class="token operator">-></span><span class="token function">is_accessible</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          local_group<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> kWalkContinue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> kWalkSkip<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    soinfo_list_t global_group <span class="token operator">=</span> local_group_ns<span class="token operator">-></span><span class="token function">get_global_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SymbolLookupList <span class="token function">lookup_list</span><span class="token punctuation">(</span>global_group<span class="token punctuation">,</span> local_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    soinfo<span class="token operator">*</span> local_group_root <span class="token operator">=</span> local_group<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> linked <span class="token operator">=</span> local_group<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Even though local group may contain accessible soinfos from other namespaces</span>
      <span class="token comment">// we should avoid linking them (because if they are not linked -> they</span>
      <span class="token comment">// are in the local_group_roots and will be linked later).</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> local_group_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> link_extinfo <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">==</span> soinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> reserved_address_recursive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Only forward extinfo for the first library unless the recursive</span>
          <span class="token comment">// flag is set.</span>
          link_extinfo <span class="token operator">=</span> extinfo<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>load_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">load_hook</span><span class="token punctuation">(</span>si<span class="token operator">-></span>load_bias<span class="token punctuation">,</span> si<span class="token operator">-></span>phdr<span class="token punctuation">,</span> si<span class="token operator">-></span>phnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        lookup_list<span class="token punctuation">.</span><span class="token function">set_dt_symbolic_lib</span><span class="token punctuation">(</span>si<span class="token operator">-></span>has_DT_SYMBOLIC <span class="token operator">?</span> si <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">link_image</span><span class="token punctuation">(</span>lookup_list<span class="token punctuation">,</span> local_group_root<span class="token punctuation">,</span> link_extinfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>relro_fd_offset<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token function">get_cfi_shadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">AfterLoad</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> <span class="token function">solist_get_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>linked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Step 7: Mark all load_tasks as linked and increment refcounts</span>
  <span class="token comment">// for references between load_groups (at this point it does not matter if</span>
  <span class="token comment">// referenced load_groups were loaded by previous dlopen or as part of this</span>
  <span class="token comment">// one on step 6)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>start_with <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> add_as_children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    start_with<span class="token operator">-></span><span class="token function">set_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    si<span class="token operator">-></span><span class="token function">set_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span>
        needed_by <span class="token operator">!=</span> start_with <span class="token operator">&amp;&amp;</span>
        needed_by<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> si<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      si<span class="token operator">-></span><span class="token function">increment_ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>


  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">load</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> <span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elf_reader<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>address_space<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   si_<span class="token operator">-></span>base <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为虚拟内存中第一个Load段的开头</span>
   si_<span class="token operator">-></span>size <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Load段的大小（必须为页的整数倍）</span>
   si_<span class="token operator">-></span><span class="token function">set_mapped_by_caller</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">is_mapped_by_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   si_<span class="token operator">-></span>load_bias <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_bias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//si_->base-min_vaddr，通常情况下是一个从内存地址到文件第一个load段地址的一个偏移</span>
   si_<span class="token operator">-></span>phnum <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">phdr_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//phdr数量</span>
   si_<span class="token operator">-></span>phdr <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">loaded_phdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加载的LOAD段</span>
   si_<span class="token operator">-></span><span class="token function">set_gap_start</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">gap_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   si_<span class="token operator">-></span><span class="token function">set_gap_size</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">gap_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/**
*CGIShadow.h
*/</span>
<span class="token keyword">constexpr</span> <span class="token keyword">unsigned</span> kLibraryAlignmentBits <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">constexpr</span> size_t kLibraryAlignment <span class="token operator">=</span> <span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> kLibraryAlignmentBits<span class="token punctuation">;</span><span class="token comment">//'0x40000'</span>
<span class="token comment">/**
*bionic/linker/linker_phdr.cpp
*/</span>
<span class="token comment">/**
*装入的流程一共三步:
1. 预留出一段能够让所有Load段载入的内存，skd大于31的时候可以使用PMD大页(2MB)
2. 使用mmap64对Load段进行映射，空白的地方用0填充
3. 检测内存是否存在phdr
4. 检测GNU section(可以不存在)

*/</span>
<span class="token keyword">bool</span> <span class="token class-name">ElfReader</span><span class="token double-colon punctuation">::</span><span class="token function">Load</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">CHECK</span><span class="token punctuation">(</span>did_read_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>did_load_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReserveAddressSpace</span><span class="token punctuation">(</span>address_space<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">LoadSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">FindPhdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">FindGnuPropertySection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    did_load_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__aarch64__<span class="token punctuation">)</span></span></span>
    <span class="token comment">// For Armv8.5-A loaded executable segments may require PROT_BTI.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>note_gnu_property_<span class="token punctuation">.</span><span class="token function">IsBTICompatible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      did_load_ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">phdr_table_protect_segments</span><span class="token punctuation">(</span>phdr_table_<span class="token punctuation">,</span> phdr_num_<span class="token punctuation">,</span> load_bias_<span class="token punctuation">,</span>
                                               <span class="token operator">&amp;</span>note_gnu_property_<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> did_load_<span class="token punctuation">;</span>



<span class="token comment">// Reserve a virtual address range big enough to hold all loadable</span>
<span class="token comment">// segments of a program header table. This is done by creating a</span>
<span class="token comment">// private anonymous mmap() with PROT_NONE.</span>
<span class="token comment">//传入的参数应该是虚拟内存的地址空间，</span>
 <span class="token comment">/**
 * address_space->reserved_size:预留地址的大小，默认为0
 *
 */</span>
<span class="token keyword">bool</span> <span class="token class-name">ElfReader</span><span class="token double-colon punctuation">::</span><span class="token function">ReserveAddressSpace</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> min_vaddr<span class="token punctuation">;</span>
  load_size_ <span class="token operator">=</span> <span class="token function">phdr_table_get_load_size</span><span class="token punctuation">(</span>phdr_table_<span class="token punctuation">,</span> phdr_num_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得要load的大小（以页来划分）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>load_size_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has no loadable segments"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">uint8_t</span><span class="token operator">*</span> addr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>min_vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> start<span class="token punctuation">;</span>
    
  <span class="token keyword">if</span> <span class="token punctuation">(</span>load_size_ <span class="token operator">></span> address_space<span class="token operator">-></span>reserved_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//load段的大小大于预留的大小的时候才在地址空间中任意地址赋值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>address_space<span class="token operator">-></span>must_use_address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"reserved address space %zd smaller than %zd bytes needed for \"%s\""</span><span class="token punctuation">,</span>
             load_size_ <span class="token operator">-</span> address_space<span class="token operator">-></span>reserved_size<span class="token punctuation">,</span> load_size_<span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    size_t start_alignment <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_transparent_hugepages_supported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//拿到最大的alignment</span>
      size_t maximum_alignment <span class="token operator">=</span> <span class="token function">phdr_table_get_maximum_alignment</span><span class="token punctuation">(</span>phdr_table_<span class="token punctuation">,</span> phdr_num_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Limit alignment to PMD size as other alignments reduce the number of</span>
      <span class="token comment">// bits available for ASLR for no benefit.</span>
        <span class="token comment">//kPmdSize=2MB'0x20000'，大多数手机应该都是4KB</span>
      start_alignment <span class="token operator">=</span> maximum_alignment <span class="token operator">==</span> kPmdSize <span class="token operator">?</span> kPmdSize <span class="token operator">:</span> PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token comment">//kLibraryAlignment=0x40000</span>
    start <span class="token operator">=</span> <span class="token function">ReserveWithAlignmentPadding</span><span class="token punctuation">(</span>load_size_<span class="token punctuation">,</span> kLibraryAlignment<span class="token punctuation">,</span> start_alignment<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gap_start_<span class="token punctuation">,</span>
                                        <span class="token operator">&amp;</span>gap_size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"couldn't reserve %zd bytes of address space for \"%s\""</span><span class="token punctuation">,</span> load_size_<span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">//如果load_size_小于reserve则会在address_space起始位置加载（reserved_size只有通过android_dlop_ext才能赋值）</span>
    start <span class="token operator">=</span> address_space<span class="token operator">-></span>start_addr<span class="token punctuation">;</span>
    gap_start_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    gap_size_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mapped_by_caller_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// Update the reserved address space to subtract the space used by this library.</span>
    address_space<span class="token operator">-></span>start_addr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>address_space<span class="token operator">-></span>start_addr<span class="token punctuation">)</span> <span class="token operator">+</span> load_size_<span class="token punctuation">;</span>
    address_space<span class="token operator">-></span>reserved_size <span class="token operator">-=</span> load_size_<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  load_start_ <span class="token operator">=</span> start<span class="token punctuation">;</span>
  load_bias_ <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">-</span> addr<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
    
    
<span class="token comment">// Reserve a virtual address range such that if it's limits were extended to the next 2**align</span>
<span class="token comment">// boundary, it would not overlap with any existing mappings.</span>

<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">ReserveWithAlignmentPadding</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> size_t mapping_align<span class="token punctuation">,</span> size_t start_align<span class="token punctuation">,</span>
                                         <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> out_gap_start<span class="token punctuation">,</span> size_t<span class="token operator">*</span> out_gap_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> mmap_flags <span class="token operator">=</span> MAP_PRIVATE <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">;</span>
  <span class="token comment">// Reserve enough space to properly align the library's start address.</span>
  mapping_align <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>mapping_align<span class="token punctuation">,</span> start_align<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mapping_align <span class="token operator">==</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> mmap_ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> PROT_NONE<span class="token punctuation">,</span> mmap_flags<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mmap_ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mmap_ptr<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Minimum alignment of shared library gap. For efficiency, this should match the second level</span>
  <span class="token comment">// page size of the platform.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span>
  <span class="token keyword">constexpr</span> size_t kGapAlignment <span class="token operator">=</span> <span class="token number">1ul</span> <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">;</span>  <span class="token comment">// 2MB</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token keyword">constexpr</span> size_t kGapAlignment <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">// Maximum gap size, in the units of kGapAlignment.</span>
  <span class="token keyword">constexpr</span> size_t kMaxGapUnits <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
  <span class="token comment">// Allocate enough space so that the end of the desired region aligned up is still inside the</span>
  <span class="token comment">// mapping.</span>
  size_t mmap_size <span class="token operator">=</span> <span class="token function">align_up</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span> <span class="token operator">+</span> mapping_align <span class="token operator">-</span> PAGE_SIZE<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span><span class="token operator">*</span> mmap_ptr <span class="token operator">=</span>
      <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> mmap_size<span class="token punctuation">,</span> PROT_NONE<span class="token punctuation">,</span> mmap_flags<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mmap_ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  size_t gap_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  size_t first_byte <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">align_up</span><span class="token punctuation">(</span>mmap_ptr<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  size_t last_byte <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">align_down</span><span class="token punctuation">(</span>mmap_ptr <span class="token operator">+</span> mmap_size<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>kGapAlignment <span class="token operator">&amp;&amp;</span> first_byte <span class="token operator">/</span> kGapAlignment <span class="token operator">!=</span> last_byte <span class="token operator">/</span> kGapAlignment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// This library crosses a 2MB boundary and will fragment a new huge page.</span>
    <span class="token comment">// Lets take advantage of that and insert a random number of inaccessible huge pages before that</span>
    <span class="token comment">// to improve address randomization and make it harder to locate this library code by probing.</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>mmap_ptr<span class="token punctuation">,</span> mmap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapping_align <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>mapping_align<span class="token punctuation">,</span> kGapAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gap_size <span class="token operator">=</span>
        kGapAlignment <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">is_first_stage_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token function">arc4random_uniform</span><span class="token punctuation">(</span>kMaxGapUnits <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mmap_size <span class="token operator">=</span> <span class="token function">align_up</span><span class="token punctuation">(</span>size <span class="token operator">+</span> gap_size<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span> <span class="token operator">+</span> mapping_align <span class="token operator">-</span> PAGE_SIZE<span class="token punctuation">;</span>
    mmap_ptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> mmap_size<span class="token punctuation">,</span> PROT_NONE<span class="token punctuation">,</span> mmap_flags<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mmap_ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>gap_end<span class="token punctuation">,</span> <span class="token operator">*</span>gap_start<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gap_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    gap_end <span class="token operator">=</span> <span class="token function">align_down</span><span class="token punctuation">(</span>mmap_ptr <span class="token operator">+</span> mmap_size<span class="token punctuation">,</span> kGapAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gap_start <span class="token operator">=</span> gap_end <span class="token operator">-</span> gap_size<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    gap_start <span class="token operator">=</span> gap_end <span class="token operator">=</span> mmap_ptr <span class="token operator">+</span> mmap_size<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">uint8_t</span><span class="token operator">*</span> first <span class="token operator">=</span> <span class="token function">align_up</span><span class="token punctuation">(</span>mmap_ptr<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span><span class="token operator">*</span> last <span class="token operator">=</span> <span class="token function">align_down</span><span class="token punctuation">(</span>gap_start<span class="token punctuation">,</span> mapping_align<span class="token punctuation">)</span> <span class="token operator">-</span> size<span class="token punctuation">;</span>

  <span class="token comment">// arc4random* is not available in first stage init because /dev/urandom hasn't yet been</span>
  <span class="token comment">// created. Don't randomize then.</span>
  size_t n <span class="token operator">=</span> <span class="token function">is_first_stage_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">arc4random_uniform</span><span class="token punctuation">(</span><span class="token punctuation">(</span>last <span class="token operator">-</span> first<span class="token punctuation">)</span> <span class="token operator">/</span> start_align <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span><span class="token operator">*</span> start <span class="token operator">=</span> first <span class="token operator">+</span> n <span class="token operator">*</span> start_align<span class="token punctuation">;</span>
  <span class="token comment">// Unmap the extra space around the allocation.</span>
  <span class="token comment">// Keep it mapped PROT_NONE on 64-bit targets where address space is plentiful to make it harder</span>
  <span class="token comment">// to defeat ASLR by probing for readable memory mappings.</span>
  <span class="token function">munmap</span><span class="token punctuation">(</span>mmap_ptr<span class="token punctuation">,</span> start <span class="token operator">-</span> mmap_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">munmap</span><span class="token punctuation">(</span>start <span class="token operator">+</span> size<span class="token punctuation">,</span> gap_start <span class="token operator">-</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gap_end <span class="token operator">!=</span> mmap_ptr <span class="token operator">+</span> mmap_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>gap_end<span class="token punctuation">,</span> mmap_ptr <span class="token operator">+</span> mmap_size <span class="token operator">-</span> gap_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>out_gap_start <span class="token operator">=</span> gap_start<span class="token punctuation">;</span>
  <span class="token operator">*</span>out_gap_size <span class="token operator">=</span> gap_size<span class="token punctuation">;</span>
  <span class="token keyword">return</span> start<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>    

<span class="token comment">/* Returns the size of the extent of all the possibly non-contiguous
 * loadable segments in an ELF program header table. This corresponds
 * to the page-aligned size in bytes that needs to be reserved in the
 * process' address space. If there are no loadable segments, 0 is
 * returned.
 *
 * If out_min_vaddr or out_max_vaddr are not null, they will be
 * set to the minimum and maximum addresses of pages to be reserved,
 * or 0 if there is nothing to load.
 */</span>
<span class="token comment">//返回所有Load段全部加载进内存之后的大小（一定是page size的倍数）</span>
size_t <span class="token function">phdr_table_get_load_size</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr_table<span class="token punctuation">,</span> size_t phdr_count<span class="token punctuation">,</span>
                                <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span> out_min_vaddr<span class="token punctuation">,</span>
                                <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span> out_max_vaddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> min_vaddr <span class="token operator">=</span> UINTPTR_MAX<span class="token punctuation">;</span>
  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> max_vaddr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> found_pt_load <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phdr_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> <span class="token operator">&amp;</span>phdr_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">!=</span> PT_LOAD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    found_pt_load <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_vaddr <span class="token operator">&lt;</span> min_vaddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      min_vaddr <span class="token operator">=</span> phdr<span class="token operator">-></span>p_vaddr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_vaddr <span class="token operator">+</span> phdr<span class="token operator">-></span>p_memsz <span class="token operator">></span> max_vaddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      max_vaddr <span class="token operator">=</span> phdr<span class="token operator">-></span>p_vaddr <span class="token operator">+</span> phdr<span class="token operator">-></span>p_memsz<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found_pt_load<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    min_vaddr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  min_vaddr <span class="token operator">=</span> <span class="token function">PAGE_START</span><span class="token punctuation">(</span>min_vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  max_vaddr <span class="token operator">=</span> <span class="token function">PAGE_END</span><span class="token punctuation">(</span>max_vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>out_min_vaddr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>out_min_vaddr <span class="token operator">=</span> min_vaddr<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>out_max_vaddr <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>out_max_vaddr <span class="token operator">=</span> max_vaddr<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> max_vaddr <span class="token operator">-</span> min_vaddr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
    
<span class="token comment">// Returns the maximum p_align associated with a loadable segment in the ELF</span>
<span class="token comment">// program header table. Used to determine whether the file should be loaded at</span>
<span class="token comment">// a specific virtual address alignment for use with huge pages.</span>
<span class="token comment">// 找alibgnment,如果是32位则默认为页的大小，如果是64位则取LOAD段中最大的p_align</span>
size_t <span class="token function">phdr_table_get_maximum_alignment</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr_table<span class="token punctuation">,</span> size_t phdr_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  size_t maximum_alignment <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phdr_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> <span class="token operator">&amp;</span>phdr_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// p_align must be 0, 1, or a positive, integral power of two.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">!=</span> PT_LOAD <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_align <span class="token operator">&amp;</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_align <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_align <span class="token operator">></span> maximum_alignment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      maximum_alignment <span class="token operator">=</span> phdr<span class="token operator">-></span>p_align<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span>
  <span class="token keyword">return</span> maximum_alignment<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token keyword">return</span> PAGE_SIZE<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span>
    
<span class="token keyword">bool</span> <span class="token class-name">ElfReader</span><span class="token double-colon punctuation">::</span><span class="token function">LoadSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phdr_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> <span class="token operator">&amp;</span>phdr_table_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">!=</span> PT_LOAD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Segment addresses in memory.</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> seg_start <span class="token operator">=</span> phdr<span class="token operator">-></span>p_vaddr <span class="token operator">+</span> load_bias_<span class="token punctuation">;</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> seg_end   <span class="token operator">=</span> seg_start <span class="token operator">+</span> phdr<span class="token operator">-></span>p_memsz<span class="token punctuation">;</span>

    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> seg_page_start <span class="token operator">=</span> <span class="token function">PAGE_START</span><span class="token punctuation">(</span>seg_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> seg_page_end   <span class="token operator">=</span> <span class="token function">PAGE_END</span><span class="token punctuation">(</span>seg_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> seg_file_end   <span class="token operator">=</span> seg_start <span class="token operator">+</span> phdr<span class="token operator">-></span>p_filesz<span class="token punctuation">;</span>

    <span class="token comment">// File offsets.</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> file_start <span class="token operator">=</span> phdr<span class="token operator">-></span>p_offset<span class="token punctuation">;</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> file_end   <span class="token operator">=</span> file_start <span class="token operator">+</span> phdr<span class="token operator">-></span>p_filesz<span class="token punctuation">;</span>

    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> file_page_start <span class="token operator">=</span> <span class="token function">PAGE_START</span><span class="token punctuation">(</span>file_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> file_length <span class="token operator">=</span> file_end <span class="token operator">-</span> file_page_start<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_size_ <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" invalid file size: %"</span> PRId64<span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file_size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_end <span class="token operator">></span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>file_size_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid ELF file \"%s\" load segment[%zd]:"</span>
          <span class="token string">" p_offset (%p) + p_filesz (%p) ( = %p) past end of file (0x%"</span> PRIx64 <span class="token string">")"</span><span class="token punctuation">,</span>
          name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_offset<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>file_end<span class="token punctuation">)</span><span class="token punctuation">,</span> file_size_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> prot <span class="token operator">=</span> <span class="token function">PFLAGS_TO_PROT</span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> <span class="token punctuation">(</span>PROT_EXEC <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>PROT_EXEC <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// W + E PT_LOAD segments are not allowed in O.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\": W+E load segments are not allowed"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span>
                                  <span class="token string">"writable-and-executable-segments-enforced-for-api-level-26"</span><span class="token punctuation">,</span>
                                  <span class="token string">"\"%s\" has load segments that are both writable and executable"</span><span class="token punctuation">,</span>
                                  name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_dlwarning</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"W+E load segments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">void</span><span class="token operator">*</span> seg_addr <span class="token operator">=</span> <span class="token function">mmap64</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>seg_page_start<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//使用mmap映射</span>
                            file_length<span class="token punctuation">,</span>
                            prot<span class="token punctuation">,</span>
                            MAP_FIXED<span class="token operator">|</span>MAP_PRIVATE<span class="token punctuation">,</span>
                            fd_<span class="token punctuation">,</span>
                            file_offset_ <span class="token operator">+</span> file_page_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>seg_addr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"couldn't map \"%s\" segment %zd: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// Mark segments as huge page eligible if they meet the requirements</span>
      <span class="token comment">// (executable and PMD aligned).</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_flags <span class="token operator">&amp;</span> PF_X<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> phdr<span class="token operator">-></span>p_align <span class="token operator">==</span> kPmdSize <span class="token operator">&amp;&amp;</span>
          <span class="token function">get_transparent_hugepages_supported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">madvise</span><span class="token punctuation">(</span>seg_addr<span class="token punctuation">,</span> file_length<span class="token punctuation">,</span> MADV_HUGEPAGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// if the segment is writable, and does not end on a page boundary,</span>
    <span class="token comment">// zero-fill it until the page limit.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_flags <span class="token operator">&amp;</span> PF_W<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PAGE_OFFSET</span><span class="token punctuation">(</span>seg_file_end<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>seg_file_end<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">-</span> <span class="token function">PAGE_OFFSET</span><span class="token punctuation">(</span>seg_file_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    seg_file_end <span class="token operator">=</span> <span class="token function">PAGE_END</span><span class="token punctuation">(</span>seg_file_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// seg_file_end is now the first page address after the file</span>
    <span class="token comment">// content. If seg_end is larger, we need to zero anything</span>
    <span class="token comment">// between them. This is done by using a private anonymous</span>
    <span class="token comment">// map for all extra pages.</span>
    <span class="token comment">//此处体现出来，memsize>filesize的时候，多出的部分为bss段</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seg_page_end <span class="token operator">></span> seg_file_end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      size_t zeromap_size <span class="token operator">=</span> seg_page_end <span class="token operator">-</span> seg_file_end<span class="token punctuation">;</span>
      <span class="token keyword">void</span><span class="token operator">*</span> zeromap <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>seg_file_end<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           zeromap_size<span class="token punctuation">,</span>
                           <span class="token function">PFLAGS_TO_PROT</span><span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_flags<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           MAP_FIXED<span class="token operator">|</span>MAP_ANONYMOUS<span class="token operator">|</span>MAP_PRIVATE<span class="token punctuation">,</span>
                           <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                           <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>zeromap <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"couldn't zero fill \"%s\" gap: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
	<span class="token comment">//进程重命名</span>
      <span class="token function">prctl</span><span class="token punctuation">(</span>PR_SET_VMA<span class="token punctuation">,</span> PR_SET_VMA_ANON_NAME<span class="token punctuation">,</span> zeromap<span class="token punctuation">,</span> zeromap_size<span class="token punctuation">,</span> <span class="token string">".bss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
    <span class="token comment">/**
    *检测内存中是否加载了phdr
    */</span>
    <span class="token keyword">bool</span> <span class="token class-name">ElfReader</span><span class="token double-colon punctuation">::</span><span class="token function">FindPhdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr_limit <span class="token operator">=</span> phdr_table_ <span class="token operator">+</span> phdr_num_<span class="token punctuation">;</span>

  <span class="token comment">// If there is a PT_PHDR, use it directly.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> phdr_table_<span class="token punctuation">;</span> phdr <span class="token operator">&lt;</span> phdr_limit<span class="token punctuation">;</span> <span class="token operator">++</span>phdr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">==</span> PT_PHDR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">CheckPhdr</span><span class="token punctuation">(</span>load_bias_ <span class="token operator">+</span> phdr<span class="token operator">-></span>p_vaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Otherwise, check the first loadable segment. If its file offset</span>
  <span class="token comment">// is 0, it starts with the ELF header, and we can trivially find the</span>
  <span class="token comment">// loaded program header from it.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> phdr_table_<span class="token punctuation">;</span> phdr <span class="token operator">&lt;</span> phdr_limit<span class="token punctuation">;</span> <span class="token operator">++</span>phdr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">==</span> PT_LOAD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_offset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span>  elf_addr <span class="token operator">=</span> load_bias_ <span class="token operator">+</span> phdr<span class="token operator">-></span>p_vaddr<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Ehdr<span class="token punctuation">)</span><span class="token operator">*</span> ehdr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Ehdr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>elf_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span>  offset <span class="token operator">=</span> ehdr<span class="token operator">-></span>e_phoff<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">CheckPhdr</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>ehdr<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"can't find loaded phdr for \"%s\""</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="链接器自举">链接器自举</h1>
<p>主要流程如下：</p>
<ol type="1">
<li>使用phdr找elf文件基址</li>
<li></li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;*
 * This is the entry point for the linker, called from begin.S. This
 * method is responsible for fixing the linker&#39;s own relocations, and
 * then calling __linker_init_post_relocation().
 *
 * Because this method is called before the linker has fixed it&#39;s own
 * relocations, any attempt to reference an extern variable, extern
 * function, or other GOT reference will generate a segfault.
 *&#x2F;
&#x2F;&#x2F;入口函数
extern &quot;C&quot; ElfW(Addr) __linker_init(void* raw_args) &#123;
  &#x2F;&#x2F; Initialize TLS early so system calls and errno work.
  KernelArgumentBlock args(raw_args);
  bionic_tcb temp_tcb __attribute__((uninitialized));
  linker_memclr(&amp;temp_tcb, sizeof(temp_tcb));
  __libc_init_main_thread_early(args, &amp;temp_tcb);

  &#x2F;&#x2F; When the linker is run by itself (rather than as an interpreter for
  &#x2F;&#x2F; another program), AT_BASE is 0.
  ElfW(Addr) linker_addr &#x3D; getauxval(AT_BASE);&#x2F;&#x2F;通过辅助向量获取linker interpreter的装载地址，对于linker自举来说，linker_addr为0（linker没有interpreter），如果为0，则通过进程执行文件的program header获取基址
  if (linker_addr &#x3D;&#x3D; 0) &#123;
    &#x2F;&#x2F; The AT_PHDR and AT_PHNUM aux values describe this linker instance, so use
    &#x2F;&#x2F; the phdr to find the linker&#39;s base address.
    ElfW(Addr) load_bias;
    get_elf_base_from_phdr(
      reinterpret_cast&lt;ElfW(Phdr)*&gt;(getauxval(AT_PHDR)), getauxval(AT_PHNUM),&#x2F;&#x2F;AT_PHDR&#x3D;3,AT_PHNUM&#x3D;5，linker_addr&#x3D;0
      &amp;linker_addr, &amp;load_bias);
  &#125;&#x2F;&#x2F;最终load_bias

  ElfW(Ehdr)* elf_hdr &#x3D; reinterpret_cast&lt;ElfW(Ehdr)*&gt;(linker_addr);&#x2F;&#x2F;对于linker来说，linker_addr &#x3D;&#x3D; elf_hdr
  ElfW(Phdr)* phdr &#x3D; reinterpret_cast&lt;ElfW(Phdr)*&gt;(linker_addr + elf_hdr-&gt;e_phoff);;&#x2F;&#x2F;linker程序头表地址

  &#x2F;&#x2F; string.h functions must not be used prior to calling the linker&#39;s ifunc resolvers.
  const ElfW(Addr) load_bias &#x3D; get_elf_exec_load_bias(elf_hdr);&#x2F;&#x2F;对于linker来说，load bias为0
      &#x2F;&#x2F;与ifunc的重定位相关，现在只有string.h有相关的ifunc实现（获取IFUNC resolver的地址，重定位.rela.iplt），详细可以看：https:&#x2F;&#x2F;github.com&#x2F;xuwakao&#x2F;wakao-blogs&#x2F;blob&#x2F;master&#x2F;android-linker&#x2F;android-ifunc.md
  call_ifunc_resolvers(load_bias);

  soinfo tmp_linker_so(nullptr, nullptr, nullptr, 0, 0);

  tmp_linker_so.base &#x3D; linker_addr;
  tmp_linker_so.size &#x3D; phdr_table_get_load_size(phdr, elf_hdr-&gt;e_phnum);
  tmp_linker_so.load_bias &#x3D; load_bias;
  tmp_linker_so.dynamic &#x3D; nullptr;
  tmp_linker_so.phdr &#x3D; phdr;
  tmp_linker_so.phnum &#x3D; elf_hdr-&gt;e_phnum;
  tmp_linker_so.set_linker_flag();

  &#x2F;&#x2F; Prelink the linker so we can access linker globals.
  if (!tmp_linker_so.prelink_image()) __linker_cannot_link(args.argv[0]);&#x2F;&#x2F;把自己链接完成之后需要找从自己的Dynamic段中找其他的动态链接时需要的数据（例如rel,symtbl等段）
    
  if (!tmp_linker_so.link_image(SymbolLookupList(&amp;tmp_linker_so), &amp;tmp_linker_so, nullptr, nullptr)) __linker_cannot_link(args.argv[0]);&#x2F;&#x2F;重定位各种符号，Got表。SymbolLookupList就是存放用于寻找符号的数据，例如gnu_chain,strtab_,stmtab_等

  return __linker_init_post_relocation(args, tmp_linker_so);&#x2F;&#x2F;初始化全局变量，静态变量
&#125;
&#x2F;*
 * This code is called after the linker has linked itself and fixed its own
 * GOT. It is safe to make references to externs and other non-local data at
 * this point. The compiler sometimes moves GOT references earlier in a
 * function, so avoid inlining this function (http:&#x2F;&#x2F;b&#x2F;80503879).
 *&#x2F;
static ElfW(Addr) __attribute__((noinline))
__linker_init_post_relocation(KernelArgumentBlock&amp; args, soinfo&amp; tmp_linker_so) &#123;
  &#x2F;&#x2F; Finish initializing the main thread.
  __libc_init_main_thread_late();

  &#x2F;&#x2F; We didn&#39;t protect the linker&#39;s RELRO pages in link_image because we
  &#x2F;&#x2F; couldn&#39;t make system calls on x86 at that point, but we can now...
  if (!tmp_linker_so.protect_relro()) __linker_cannot_link(args.argv[0]);

  &#x2F;&#x2F; And we can set VMA name for the bss section now
  set_bss_vma_name(&amp;tmp_linker_so);

  &#x2F;&#x2F; Initialize the linker&#39;s static libc&#39;s globals
  __libc_init_globals();

  &#x2F;&#x2F; Initialize the linker&#39;s own global variables
  tmp_linker_so.call_constructors();

  &#x2F;&#x2F; Setting the linker soinfo&#39;s soname can allocate heap memory, so delay it until here.
  for (const ElfW(Dyn)* d &#x3D; tmp_linker_so.dynamic; d-&gt;d_tag !&#x3D; DT_NULL; ++d) &#123;
    if (d-&gt;d_tag &#x3D;&#x3D; DT_SONAME) &#123;
      tmp_linker_so.set_soname(tmp_linker_so.get_string(d-&gt;d_un.d_val));
    &#125;
  &#125;

  &#x2F;&#x2F; When the linker is run directly rather than acting as PT_INTERP, parse
  &#x2F;&#x2F; arguments and determine the executable to load. When it&#39;s instead acting
  &#x2F;&#x2F; as PT_INTERP, AT_ENTRY will refer to the loaded executable rather than the
  &#x2F;&#x2F; linker&#39;s _start.
  const char* exe_to_load &#x3D; nullptr;
  if (getauxval(AT_ENTRY) &#x3D;&#x3D; reinterpret_cast&lt;uintptr_t&gt;(&amp;_start)) &#123;
    if (args.argc &#x3D;&#x3D; 3 &amp;&amp; !strcmp(args.argv[1], &quot;--list&quot;)) &#123;
      &#x2F;&#x2F; We&#39;re being asked to behave like ldd(1).
      g_is_ldd &#x3D; true;
      exe_to_load &#x3D; args.argv[2];
    &#125; else if (args.argc &lt;&#x3D; 1 || !strcmp(args.argv[1], &quot;--help&quot;)) &#123;
      async_safe_format_fd(STDOUT_FILENO,
         &quot;Usage: %s [--list] PROGRAM [ARGS-FOR-PROGRAM...]\n&quot;
         &quot;       %s [--list] path.zip!&#x2F;PROGRAM [ARGS-FOR-PROGRAM...]\n&quot;
         &quot;\n&quot;
         &quot;A helper program for linking dynamic executables. Typically, the kernel loads\n&quot;
         &quot;this program because it&#39;s the PT_INTERP of a dynamic executable.\n&quot;
         &quot;\n&quot;
         &quot;This program can also be run directly to load and run a dynamic executable. The\n&quot;
         &quot;executable can be inside a zip file if it&#39;s stored uncompressed and at a\n&quot;
         &quot;page-aligned offset.\n&quot;
         &quot;\n&quot;
         &quot;The --list option gives behavior equivalent to ldd(1) on other systems.\n&quot;,
         args.argv[0], args.argv[0]);
      _exit(EXIT_SUCCESS);
    &#125; else &#123;
      exe_to_load &#x3D; args.argv[1];
      __libc_shared_globals()-&gt;initial_linker_arg_count &#x3D; 1;
    &#125;
  &#125;

  &#x2F;&#x2F; store argc&#x2F;argv&#x2F;envp to use them for calling constructors
  g_argc &#x3D; args.argc - __libc_shared_globals()-&gt;initial_linker_arg_count;
  g_argv &#x3D; args.argv + __libc_shared_globals()-&gt;initial_linker_arg_count;
  g_envp &#x3D; args.envp;
  __libc_shared_globals()-&gt;init_progname &#x3D; g_argv[0];

  &#x2F;&#x2F; Initialize static variables. Note that in order to
  &#x2F;&#x2F; get correct libdl_info we need to call constructors
  &#x2F;&#x2F; before get_libdl_info().
  sonext &#x3D; solist &#x3D; solinker &#x3D; get_libdl_info(tmp_linker_so);
  g_default_namespace.add_soinfo(solinker);

  ElfW(Addr) start_address &#x3D; linker_main(args, exe_to_load);&#x2F;&#x2F;最后会调用findlibrarys，返回linker在虚拟内存的地址

  if (g_is_ldd) _exit(EXIT_SUCCESS);

  INFO(&quot;[ Jumping to _start (%p)... ]&quot;, reinterpret_cast&lt;void*&gt;(start_address));

  &#x2F;&#x2F; Return the address that the calling assembly stub should jump to.
  return start_address;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="寄存器pc到so文件pc的映射关系">寄存器PC到so文件PC的映射关系</h1>
<p>研究链接器的代码我们发现，如下几点：</p>
<ol type="1">
<li>只要不使用android_dlopen_ext()设置加载初始地址的时候，在链接器给so文件预留空间的时候就会在地址空间内随机分配一个初始地址这个初始地址就导致Load的基地址(简称base)一直发生变化；</li>
<li>装入的时候所有的Load段的起始地址均为base+p_vaddr，并且LOAD段进行mmap的时候均是从p_offset开始映射</li>
</ol>
<p>因此我们就能够推算出寄存器PC到so文件PC的映射关系：</p>
<p>其中base为elf文件在内存的基地址；</p>
<p>$PC_{virtual} $为虚拟地址中的PC；</p>
<p>$ PC_{reg}$为PC寄存器的值；</p>
<p><span class="math inline">\(PC_{real}\)</span>为so文件的PC的值；</p>
<p>其余的以p开头的均是elf文件中phdr中能够读到的数据 <span class="math display">\[
PC_{virtual}  = PC_{reg} -base \\
virtualBias = PC_{virtual}-pVirtual \\
PC_{real} = virtualBias+pOffset \\
\]</span> 最终得到如下公式 <span class="math display">\[
PC_{real} = PC_{reg}-base-pVirtual+pOffset
\]</span></p>
<h2 id="验证过程">验证过程：</h2>
<p>我们随便写一个demo:</p>
<p>使用lldb查看pc寄存器的值以及所对应的汇编</p>
<p><img src="/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805220820178.png" alt="image-20210805220820178" style="zoom:67%;"></p>
<p>查看对应段的基地址，为0x000000756303a000</p>
<figure>
<img src="/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221048906.png" alt><figcaption>image-20210805221048906</figcaption>
</figure>
<p>使用readelf查看so文件的phdr</p>
<figure>
<img src="/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221126743.png" alt><figcaption>image-20210805221126743</figcaption>
</figure>
<p>最终，使用上述公式，推算出 <span class="math display">\[
PC_{real} = 0x000000756304f33c-0x000000756303a000-0x15000+0x15000 =0x1533c 
\]</span> 我们使用ida pro查看地址0x1533c</p>
<figure>
<img src="/2023/08/05/android-dlopen%E6%B5%81%E7%A8%8B/image-20210805221336854.png" alt><figcaption>image-20210805221336854</figcaption>
</figure>
<p>发现所在的行和使用lldb的反汇编看到的一模一样。因此证明公式正确</p>
<h2 id="本篇纪念逝去的鹅">本篇纪念逝去的鹅</h2>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/c/" rel="tag"># c++</a>
              <a href="/tags/%E9%B9%85/" rel="tag"># 鹅</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/08/05/android-validation-layer%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B/" rel="prev" title="android_validation_layer调用过程">
                  <i class="fa fa-angle-left"></i> android_validation_layer调用过程
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2014 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">GXG</span>
  </div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/pjax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/search/local-search.min.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/tags/mermaid.min.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/wavedrom.min.js","integrity":"sha256-IRMDzTC+wK5stMucZ/XSXkeS5VNtxZ+/Bm8Mcqfoxdo="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/tags/wavedrom.min.js"></script>




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","mhchem":true,"cdn2":"https://cdn.bootcss.com/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML","cdn3":"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/math/mathjax.min.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"next-theme","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.18.0/third-party/comments/disqus.min.js"></script>

</body>
</html>
